[filament_motion_sensor extruder_sensor]
extruder: extruder
detection_length: 14.0
event_delay: 120.0
switch_pin: PG14
pause_on_runout: False
runout_gcode:
    {% if printer.virtual_sdcard.is_active %}
        SAVE_GCODE_STATE NAME=extruder_sensor
        MOVE_TO_SERVICE_POSITION
        G91
        G0 E15 F600
        G90
        CHECK_FILAMENT_MOTION_SENSOR SENSOR='extruder_sensor'
    {% else %}
        FILAMENT_ERROR EXTRUDER=extruder
    {% endif %}


[gcode_macro FILAMENT_ERROR]
gcode:
    {% if params.EXTRUDER == 'extruder' %}
        {action_raise_error('Filament error on Extruder 1')}
    {% else %}
        {action_raise_error('Filament error on Extruder 2')}
    {% endif %}

[gcode_macro SET_FILAMENT_SENSOR]
rename_existing: SET_FILAMENT_SENSOR_OLD
gcode:
    SET_FILAMENT_SENSOR_OLD SENSOR={params.SENSOR} ENABLE={params.ENABLE}
    SAVE_VARIABLE VARIABLE={params.SENSOR} VALUE={params.ENABLE}

[gcode_macro CHECK_FILAMENT_MOTION_SENSOR]
gcode:
    {% set sensor = params.SENSOR|default('extruder_sensor') %}
    {% set filament_detected = printer['filament_motion_sensor ' ~ sensor].filament_detected %}
    {% if filament_detected %}
        RESTORE_GCODE_STATE NAME={sensor} MOVE=1 MOVE_SPEED=30
    {% else %}
        PAUSE TURN_OFF_EXTRUDERS=0
        UPDATE_DELAYED_GCODE ID=TURN_OFF_EXTRUDERS_DELAYED DURATION=300
    {% endif %}

[gcode_macro GET_STATE_SWITH]
description: get state motion filament sensor
variable_status_swith: 0
gcode:
    {% set status = printer['filament_motion_sensor extruder_sensor'].filament_detected %}
    SET_GCODE_VARIABLE MACRO=GET_STATE_SWITH VARIABLE=status_swith VALUE={status}
    { action_respond_info("variable_status_swith =%d" % (status))}
