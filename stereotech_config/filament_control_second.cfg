[filament_motion_sensor extruder1_sensor]
extruder: extruder1
detection_length: 14.0
event_delay: 120.0
switch_pin: PG15
pause_on_runout: False
runout_gcode:
    {% if printer.virtual_sdcard.is_active %}
        {action_respond_info('----------trigered second extruder')}
        SAVE_GCODE_STATE NAME=extruder1_sensor
        OFFSET_FOR_NOZZLE ACTION=reset
        SAVE_GCODE_STATE NAME=PAUSE_STATE
        MOVE_TO_SERVICE_POSITION
        G91
        G0 E15 F600
        G90
        CHECK_FILAMENT_MOTION_SENSOR SENSOR='extruder1_sensor'
        SET_GCODE_VARIABLE MACRO=OFFSET_FOR_NOZZLE VARIABLE=triggered_extruder VALUE=2

        {% if triggered_extruder + triggered_extruder_old == 3 %} ; we are back to the main extruder from gcode
            SET_GCODE_VARIABLE MACRO=OFFSET_FOR_NOZZLE VARIABLE=enabled VALUE=0
            {action_respond_info('----------enabled == 0')}
        {% else %}
            SET_GCODE_VARIABLE MACRO=OFFSET_FOR_NOZZLE VARIABLE=enabled VALUE=1
            {action_respond_info('----------enabled == 1')}
        {% endif %}
        {% if printer["gcode_macro OFFSET_FOR_NOZZLE"].triggered_extruder_old|int == 0 %}
            {action_respond_info('---------- triggered_extruder_old == 1')}
           SET_GCODE_VARIABLE MACRO=OFFSET_FOR_NOZZLE VARIABLE=triggered_extruder_old VALUE={ triggered_extruder }
        {% endif %}

        UPDATE_DELAYED_GCODE ID=TURN_ON_ANOTHER_EXTRUDERS_DELAYED DURATION=60
        
    {% else %}
        FILAMENT_ERROR EXTRUDER=extruder1
    {% endif %}
