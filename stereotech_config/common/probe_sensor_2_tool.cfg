[gcode_macro CALC_TOOL_PARAMS]
description: Tool lendth and radius calculation
variable_length: 999.0
variable_radius: 999.0
gcode:
    {% if params.LENGTH|default(0) > 0 %}
        {% if params.PROBE|default(1) > 0%}
            PROBE_TOOL_POINT POINT=A_Z
            ADJUST_BASEMENT_WCS_V2 WCS=0
        {% endif %}
        SET_TOOL_LENGTH
    {% endif %}
    {% if params.RADIUS|default(0) > 0 %}
        PROBE_TOOL_POINT POINT=A_Z_A90
        SET_TOOL_RADIUS
    {% endif %}

[gcode_macro SET_TOOL_LENGTH]
description: This macro calculate length tool.
gcode:
    {% set old_z = printer.gcode_move.wcs_offsets[3][2] %}
    {% set template_thickness = 10.0 %}
    {% set wcs_1_z = printer.gcode_move.wcs_offsets[1][2] %}
    {% set tool_length = wcs_1_z - (old_z + template_thickness) %}
    SET_GCODE_VARIABLE MACRO=CALC_TOOL_PARAMS VARIABLE=length VALUE={tool_length}
    {action_respond_info('tool length=%s' % tool_length)}

[gcode_macro SET_TOOL_RADIUS]
description: moved to measure tool radius and calculate it.
gcode:
    {% set wcs_z = printer.gcode_move.wcs_offsets[4][2] %}
    {% set point = printer.probe.last_result %}
    {% set offsets = printer.probe.offsets %}
    {% set z = point[2] - offsets[2] - printer.gcode_move.homing_origin.z %}
    SET_GCODE_VARIABLE MACRO=CALC_TOOL_PARAMS VARIABLE=radius VALUE={z - wcs_z}
    SET_POINT MACRO=SAVE_WCS_CALC_POINT POINT=0
    PROBE_TOOL_POINT POINT=A_X_A90
    SET_POINT MACRO=SAVE_WCS_CALC_POINT POINT=1
    PROBE_TOOL_POINT POINT=A_MX_A90
    SET_POINT MACRO=SAVE_WCS_CALC_POINT POINT=2
    PROBE_TOOL_POINT POINT=A_Z_A90
    CALC_PRECISE_RADIUS

[gcode_macro CALC_PRECISE_RADIUS]
gcode:
    {% approximate = printer['gcode_macro CALC_TOOL_PARAMS'].radius %}
    CALC_TOOL_RADIUS APPROXIMATE={approximate}
    SET_PRECISE_RADIUS

[gcode_macro SET_PRECISE_RADIUS]
gcode:
    SET_GCODE_VARIABLE MACRO=CALC_TOOL_PARAMS VARIABLE=radius VALUE={printer.auto_wcs.tooling_radius}
    {% set point = printer.probe.last_result %}
    {% set offsets = printer.probe.offsets %}
    {% set z = point[2] - offsets[2] - printer.gcode_move.homing_origin.z %}
    {% set radius = printer.auto_wcs.tooling_radius %}
    {% set auto_wcs_adj = printer.save_variables.variables["auto_wcs_adj"]|default(0.0)|float %}
    G10 L2 P3 Z{z - radius + auto_wcs_adj}

