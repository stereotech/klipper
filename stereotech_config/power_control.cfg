[gcode_button power_detection]
pin: !PC0
press_gcode:
    {% if printer.virtual_sdcard.is_active %}
        PAUSE
    {% endif %}
    POWER_OFF

[output_pin power_pin]
pin: !PE11

[gcode_macro POWER_OFF]
gcode:
    {action_respond_info('Power off')}
    M150 R255 G64 B0
    SET_PIN PIN=power_pin VALUE=1
    G4 P10000
    POWER_OFF_HOST

[gcode_macro POWER_OFF_HOST]
gcode:
    {action_call_remote_method('shutdown_machine')}

[gcode_macro POWER_OFF_AT_END]
gcode:
    SET_GCODE_VARIABLE MACRO=END VARIABLE=power_off VALUE={params.VALUE|default(0)}
