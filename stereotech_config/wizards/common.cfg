[gcode_macro CHANGE_STEP_AND_WAIT_HEATING]
gcode:
    {% set wizard = params.WIZARD %}
    {% set step = params.STEP %}
    {% set temperature = params.TEMP %}
    {% set selected_e = params.EXTRUDER %}
    SET_HEATER_TEMPERATURE HEATER={selected_e} TARGET={temperature}
    WIZARD_STEP_LOADING_STATE WIZARD={wizard} STEP={step} ENABLE=1
    SET_WIZARD_STEP WIZARD={wizard} STEP={step}
    M109 S{temperature}
    WIZARD_STEP_LOADING_STATE WIZARD={wizard} STEP={step} ENABLE=0

[gcode_macro RESET_WIZARD]
rename_existing: RESET_WIZARD_OLD
gcode:
    {% set wizard = params.WIZARD %}
    {% set abort = params.ABORT|default(1)|int %}
    {% if printer["probe"] %}
        CANCEL_TEST_PROBE
        UPDATE_DELAYED_GCODE ID=test_probe_loop_two DURATION=0.0
    {% endif %}
    TURN_OFF_HEATERS
    HOME_POSITION ABORT={abort}
    RESET_WIZARD_OLD WIZARD={wizard}

[gcode_macro CHANGE_STEP_AND_WAIT_PROBE]
variable_wizard: ''
variable_step: ''
gcode:
    {% set wizard = params.WIZARD %}
    {% set step = params.STEP %}
    SET_GCODE_VARIABLE MACRO=CHANGE_STEP_AND_WAIT_PROBE VARIABLE=wizard VALUE={["'" ~ wizard ~ "'"]}
    SET_GCODE_VARIABLE MACRO=CHANGE_STEP_AND_WAIT_PROBE VARIABLE=step VALUE={["'" ~ step ~ "'"]}
    WIZARD_STEP_LOADING_STATE WIZARD={wizard} STEP={step} ENABLE=1
    SET_WIZARD_STEP WIZARD={wizard} STEP={step}
    UPDATE_DELAYED_GCODE ID=test_probe_loop_two DURATION=1.0
    TEST_PROBE

[delayed_gcode test_probe_loop_two]
gcode:
    {% if printer["probe"].last_query %}
        UPDATE_DELAYED_GCODE ID=test_probe_loop_two DURATION=0.0
        {% set wizard = printer["gcode_macro CHANGE_STEP_AND_WAIT_PROBE"].wizard %}
        {% set step = printer["gcode_macro CHANGE_STEP_AND_WAIT_PROBE"].step %}
        WIZARD_STEP_LOADING_STATE WIZARD={wizard[0]} STEP={step[0]} ENABLE=0
    {% else %}
        QUERY_PROBE
        UPDATE_DELAYED_GCODE ID=test_probe_loop_two DURATION=1.0
    {% endif %}

[wizard_step CLEAR_NOZZLE0]
image: none
landscape: false
description: ClearNozzle.WaitHeating
warning: none
countdown: 0
info: none
placeholder: wizard-step-preheat
action_gcode:
    RETRACT_MATERIAL
    SET_WIZARD_STEP WIZARD={wizard.name} STEP=CLEAR_NOZZLE1
cancel_gcode:
    RESET_WIZARD WIZARD={wizard.name}

[wizard_step CLEAR_NOZZLE1]
image: none
landscape: false
description: ClearNozzle.NozzleClear
warning: none
countdown: 0
info: none
action_gcode:
    TURN_OFF_HEATERS
    MOVE_SERVICE_POSITION
    {% set continue_from_step = printer['wizard ' ~ wizard.name].variables.continue_from_step %}
    SET_WIZARD_STEP WIZARD={wizard.name} STEP={continue_from_step}
cancel_gcode:
    RESET_WIZARD WIZARD={wizard.name}

[gcode_macro JOG_DO_MOVE]
gcode:
    {% set axis = params.AXIS|default('X')|upper %}
    {% set direction = '+' if params.DIRECTION|default(1)|int else '-' %}
    {% set step_name = params.STEP_NAME %}
    {% set val = printer["wizard_step_jog " ~ step_name].step %}
    G91
    G1 {axis ~ direction ~ val} F1500
    G90
    {action_respond_info('-------------------jog_gcode (G1 %s%s%s} F1500)' % (axis, direction, val))}
